<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Quick Links – Dynamic</title>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  
<style>
    :root{
        --bg:#f5f5f5;
        --card:#fff;
        --muted:#666;
        --accent:#111;
        --shadow:0 2px 5px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background:var(--bg);
        color:#222;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
    }
    header{
        background:var(--accent);
        color:#fff;
        padding:16px;
    }
    header h1{
        margin:0;
        font-size:18px;
        font-weight:600;
        cursor:pointer;
    }
    .container-custom{
        max-width:1400px;
        margin:20px auto;
        padding:0 16px 60px;
    }
    .section-title{
        font-size:13px;
        font-weight:600;
        margin:6px 0 14px;
        color:var(--muted);
    }
    .shortcut-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill, minmax(120px,1fr));
        gap:16px;
        padding: 4px;
        border-radius: 12px;
        transition: background .2s ease;
    }
    
    .shortcut-grid.highlight-drop {
      background: rgba(0, 123, 255, 0.1); 
      outline: 2px dashed rgba(0, 123, 255, 0.5);
    }

    .shortcut.drop-before {
        border-top: 3px solid #007bff;
        padding-top: 5px;
    }
    .shortcut.drop-after {
        border-bottom: 3px solid #007bff;
        padding-bottom: 5px;
    }
    
    .shortcut.dragging {
        opacity: 0.5;
        border: 2px solid var(--accent);
    }

    @keyframes rotateBorder {
        to {
            transform: rotate(1turn);
        }
    }

    .shortcut{
        border-radius:12px;
        box-shadow:var(--shadow);
        text-align:center;
        padding:8px;
        display:block;
        gap:6px;
        text-decoration:none;
        color:inherit;
        position:relative;
        overflow:hidden;
        transition:transform .14s ease, box-shadow .14s ease;
        min-height:125px;
        cursor: grab;
        transition: transform .14s ease, box-shadow .14s ease, border .1s ease, padding .1s ease;
    }

    .shortcut:hover{ 
        transform:translateY(-6px); 
        box-shadow:0 8px 22px rgba(0,0,0,0.16); 
    }
    
    .shortcut::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        z-index: 0;
        opacity: 0; 
        border-radius: inherit;
        background: conic-gradient(
            #ff0000, #ff8c00, #ffff00, #00ff00, #00ffff, #0000ff, #8a2be2, #ff0000
        );
        transition: opacity .3s ease;
    }
    
    .shortcut:hover::before {
        opacity: 1; 
        animation: rotateBorder 3s linear infinite; 
    }
    
    .shortcut-inner {
        position: absolute;
        inset: 2px;
        background: var(--card); 
        border-radius: 10px;
        z-index: 1;
        padding:12px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        gap:8px;
        height: calc(100% - 4px);
    }
    
    .icon{
        font-size: clamp(18px, 5vw, 28px); /*   FONT SIZE  */
        font-weight: 900;  /*   FONT SIZE  */
        margin:0 auto;        /*   FONT SIZE  */
        color: #111;  /*   FONT SIZE  */
        overflow: hidden;   /*   FONT SIZE  */                 
        width:44px;
        height:44px;
        border-radius:50%;
        background:#e9e9e9;
        display:inline-flex;
        align-items:center;
        justify-content:center;

    }
    
    .icon img {
        width: 35px;
        height: 35px;
        object-fit: contain;
    }
    
    .icon.has-favicon {
        font-size: 0;
    }
    
    .shortcut .title{
        font-size: clamp(12px, 3.2vw, 15px); /*   FONT SIZE  */
        font-weight:600; /*   FONT SIZE  */
        color:#111;
        word-break:break-word;
    }
    .shortcut .url{
        font-size: clamp(9px, 2.5vw, 12px);/*   FONT SIZE  */
        color:var(--muted); 
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; 
        width: 100%;
        word-break: break-all;
    }

    .menu-btn{
        position:absolute;
        top:8px;
        right:8px;
        width:30px;
        height:30px;
        border-radius:6px;
        background:transparent;
        border:0;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        opacity:.9;
        z-index:2;
    }

    .menu-btn:hover{ background:rgba(0,0,0,0.04); }
    .menu{
        position:absolute;
        top:36px;
        right:8px;
        background:#fff;
        border-radius:8px;
        box-shadow:0 8px 20px rgba(0,0,0,0.14);
        min-width:120px;
        z-index:30;
        overflow:hidden;
        display:none;
        flex-direction:column;
    }
    .menu.visible{ display:flex; }
    .menu button{
        border:0;
        background:transparent;
        padding:8px 12px;
        text-align:left;
        cursor:pointer;
        width:100%;
        font-size:13px;
    }
    .menu button:hover{ background:rgba(0,0,0,0.04); }
    
    .modal-content {
        border-radius:12px;
        padding:18px;
        box-shadow:0 20px 60px rgba(0,0,0,0.2);
        border:0;
    }
    .modal-header {
        border:0;
        padding:0 0 10px 0;
    }
    .modal-header h2 {
        margin:0;
        font-size:17px;
    }
    .modal-body {
        padding:8px 0;
    }
    .modal-footer {
        border:0;
        padding:10px 0 0 0;
        justify-content:flex-end;
        gap:8px;
    }
    
    .form-label{ 
        font-size:12px; 
        color:var(--muted);
        margin-bottom:6px;
    }
    .form-control, .form-select {
        padding:10px 12px;
        border-radius:8px;
        border:1px solid #e2e2e2;
        font-size:14px;
    }
    .form-control:focus, .form-select:focus {
        border-color:#e2e2e2;
        box-shadow:none;
    }
    input[type="color"].form-control{
        height: 38px;
        padding: 0 4px;
    }
    
    .btn-custom-secondary{ 
        background:#f0f0f0; 
        color:#111;
        border:0;
        padding:8px 12px;
        border-radius:8px;
        font-weight:600;
        font-size:13px;
    }
    .btn-custom-primary{ 
        background:var(--accent); 
        color:#fff;
        border:0;
        padding:8px 12px;
        border-radius:8px;
        font-weight:600;
        font-size:13px;
    }
    .btn-custom-secondary:hover{ 
        background:#e5e5e5; 
        color:#111;
    }
    .btn-custom-primary:hover{ 
        background:#000; 
        color:#fff;
    }
    
    .header-icon-btn{
        background:rgba(255,255,255,0.1);
        border:0;
        border-radius:6px;
        width:36px;
        height:36px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        color:#fff;
        transition:background .2s ease;
    }
    .header-icon-btn:hover{
        background:rgba(255,255,255,0.2);
    }
    .empty{
        padding:26px;
        border-radius:12px;
        background:linear-gradient(180deg,#fff,#fbfbfb);
        text-align:center;
        color:var(--muted);
        box-shadow:var(--shadow);
    }
    
    .tooltip {
        font-size: 12px;
    }
    .tooltip-inner {
        max-width: 300px;
        padding: 6px 10px;
        text-align: left;
        word-break: break-all;
    }
</style>
</head>
<body>
<header>
  <div class="container-fluid">
    <div class="row align-items-center justify-content-between">
      <div class="col-auto">
        <h1 id="addHeaderBtn">+ My Personal Quick Links</h1>
      </div>
      <div class="col-auto">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex gap-2">
            <button id="exportBtn" class="header-icon-btn" title="Export links as JSON">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
              </svg>
            </button>
            <button id="importBtn" class="header-icon-btn" title="Import links from JSON">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
            </button>
          </div>
          <div style="color:#ddd;font-size:13px;">Tools & Idea by | Arvin Acosta</div>
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="importFileInput" accept=".json" style="display:none;" />
</header>

<main class="container-custom" role="main">
  <div id="linksContainer"></div>
  <div style="height:18px"></div>
  <div class="text-muted" style="font-size:13px;">Tip: Click a tile to open. Use three dots to edit or delete. **Drag and drop cards** to move them between categories or reorder them within a category. Changes are saved in IndexedDB.</div>
</main>

<div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Add Link</h2>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="inputLabel" class="form-label">Display Label</label>
          <input id="inputLabel" type="text" class="form-control" placeholder="e.g. D1 Registration Form" />
        </div>
        <div class="mb-3">
          <label for="inputUrl" class="form-label">URL or File Path</label>
          <input id="inputUrl" type="text" class="form-control" placeholder="https://example.com or file:///C:/path/to/file.pdf" />
        </div>
        <div class="mb-3">
          <label for="inputCategory" class="form-label">Category</label>
          <input id="inputCategory" type="text" class="form-control" placeholder="e.g. Work, Personal, Shopping, etc." list="categoryList" />
          <datalist id="categoryList"></datalist>
          <small class="text-muted" style="font-size: 11px;">Type a new category or select an existing one</small>
        </div>
        <div class="mb-3">
            <label for="inputFavicon" class="form-label">Favicon URL (Optional)</label>
            <input id="inputFavicon" type="text" class="form-control" placeholder="... for Google S2, leave blank for text" />
            <small class="text-muted" style="font-size: 11px;">Use "..." for Google S2, "" for text, or direct URL</small>
        </div>
        <div class="mb-3">
          <label for="inputColor" class="form-label">Icon Background Color (Optional)</label>
          <input id="inputColor" type="color" class="form-control form-control-color w-100" value="#e9e9e9" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelBtn" class="btn btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveBtn" class="btn btn-custom-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
// ======================
// INDEXEDDB SETUP
// ======================
const DB_NAME = 'QuickLinksDB';
const STORE_NAME = 'links';
let db = null;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
    request.onsuccess = (e) => {
      db = e.target.result;
      resolve(db);
    };
    request.onerror = (e) => reject(e);
  });
}

async function idbGetAll() {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function idbPut(item) {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.put(item);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

async function idbDelete(id) {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

async function idbClear() {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const request = store.clear();
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// ======================
// STATE
// ======================
let allLinks = [];
let lastSelectedColor = localStorage.getItem('QLinkLastColor') || '#e9e9e9';
let modalInstance = null;
let tooltipInstances = [];
let draggedId = null;
let dropPlacement = null;
let targetId = null;
let editingId = null;
let isSaving = false; // ← PREVENT RACE

// ======================
// PERSISTENCE
// ======================
async function loadAllLinks() {
  try {
    const stored = await idbGetAll();
    if (stored.length > 0) {
      allLinks = stored.sort((a, b) => {
        const cat = a.category.localeCompare(b.category);
        if (cat !== 0) return cat;
        return a.sortOrder - b.sortOrder;
      });
    } else {
      allLinks = [];  // ← NOW EMPTY ON FIRST RUN
    }
  } catch (err) {
    console.error("IndexedDB load failed:", err);
    allLinks = [];  // ← Also empty on error
  }
  return allLinks;
}



async function saveAllLinks(links) {
  // Removed: allLinks = links; ← handled by caller
  try {
    await idbClear();
    for (const link of links) {
      await idbPut(link);
    }
  } catch (err) {
    console.error("IndexedDB save failed:", err);
  }
}

// ======================
// DRAG & DROP (FIXED)
// ======================
function handleDragStart(ev) {
  draggedId = ev.target.closest('.shortcut').dataset.id;
  ev.dataTransfer.effectAllowed = 'move';
  ev.target.classList.add('dragging');
}

function handleDragEnd(ev) {
  ev.target.classList.remove('dragging');
  document.querySelectorAll('.shortcut.drop-before, .shortcut.drop-after').forEach(el => el.classList.remove('drop-before', 'drop-after'));
  document.querySelectorAll('.shortcut-grid.highlight-drop').forEach(el => el.classList.remove('highlight-drop'));
}

function handleDragOver(ev) {
  ev.preventDefault();
  ev.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(ev) {
  const grid = ev.target.closest('.shortcut-grid');
  const card = ev.target.closest('.shortcut');
  if (grid && !card) {
    grid.classList.add('highlight-drop');
  }
  if (card && card.dataset.id !== draggedId) {
    const rect = card.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    if (ev.clientY < midY) {
      card.classList.add('drop-before');
      card.classList.remove('drop-after');
      dropPlacement = 'before';
    } else {
      card.classList.add('drop-after');
      card.classList.remove('drop-before');
      dropPlacement = 'after';
    }
    targetId = card.dataset.id;
  }
}

function handleDragLeave(ev) {
  const grid = ev.target.closest('.shortcut-grid');
  const card = ev.target.closest('.shortcut');
  if (grid && !ev.relatedTarget?.closest('.shortcut-grid')) {
    grid.classList.remove('highlight-drop');
  }
  if (card) {
    card.classList.remove('drop-before', 'drop-after');
  }
}

async function handleDrop(ev) {
  ev.preventDefault();
  if (isSaving) return; // ← PREVENT DOUBLE SAVE
  isSaving = true;

  document.querySelectorAll('.shortcut.drop-before, .shortcut.drop-after').forEach(el => el.classList.remove('drop-before', 'drop-after'));
  document.querySelectorAll('.shortcut-grid.highlight-drop').forEach(el => el.classList.remove('highlight-drop'));
  
  const idToMove = parseInt(draggedId);
  if (isNaN(idToMove)) { isSaving = false; return; }

  const itemToMove = allLinks.find(x => x.id == idToMove);
  if (!itemToMove) { isSaving = false; return; }

  const currentLinks = [...allLinks];
  const draggedIndex = currentLinks.findIndex(x => x.id == idToMove);
  currentLinks.splice(draggedIndex, 1);
  
  let newCategory = itemToMove.category;
  
  if (targetId) {
      const targetItem = currentLinks.find(x => x.id == targetId);
      if (!targetItem) { isSaving = false; return; }
      newCategory = targetItem.category;
      let targetIndex = currentLinks.findIndex(x => x.id == targetItem.id);
      let newIndex = dropPlacement === 'after' ? targetIndex + 1 : targetIndex;
      itemToMove.category = newCategory;
      currentLinks.splice(newIndex, 0, itemToMove);
  } else {
      const dropTarget = ev.target.closest('.shortcut-grid');
      if (!dropTarget) { isSaving = false; return; }
      const titleElement = dropTarget.previousSibling;
      newCategory = titleElement.textContent;
      itemToMove.category = newCategory;
      currentLinks.push(itemToMove); 
  }

  const categorizedLinks = currentLinks.reduce((acc, link) => {
      acc[link.category] = acc[link.category] || [];
      acc[link.category].push(link); 
      return acc;
  }, {});

  let finalLinks = [];
  const sortedCategories = Object.keys(categorizedLinks).sort((a, b) => a.localeCompare(b));
  
  for (const cat of sortedCategories) {
      const catLinks = categorizedLinks[cat];
      for (let i = 0; i < catLinks.length; i++) {
          catLinks[i].sortOrder = i; 
          finalLinks.push(catLinks[i]);
      }
  }
  
  allLinks = finalLinks; // ← UPDATE STATE BEFORE SAVE
  await saveAllLinks(finalLinks);
  await renderAll();
  await updateCategoryDatalist();
  isSaving = false;
}

// ======================
// RENDER
// ======================
async function renderAll(){
  tooltipInstances.forEach(tooltip => tooltip.dispose());
  tooltipInstances = [];
  
  const sortedItems = [...allLinks].sort((a, b) => {
      const catCompare = a.category.localeCompare(b.category);
      if (catCompare !== 0) return catCompare;
      return a.sortOrder - b.sortOrder;
  });

  let categories = [...new Set(allLinks.map(x => x.category))].sort((a, b) => a.localeCompare(b));
  
  linksContainer.innerHTML='';
  for(const cat of categories){
    const catItems=sortedItems.filter(x=>x.category===cat);
    if(!catItems.length) continue;
    
    const titleEl=document.createElement('div');
    titleEl.className='section-title';
    titleEl.textContent=cat;
    
    const grid=document.createElement('div');
    grid.className='shortcut-grid';
    
    grid.addEventListener('dragover', handleDragOver);
    grid.addEventListener('dragenter', handleDragEnter);
    grid.addEventListener('dragleave', handleDragLeave);
    grid.addEventListener('drop', handleDrop);

    catItems.forEach(item=>{
      const a=document.createElement('a');
      a.className='shortcut';
      a.href=item.link;
      a.target='_blank';
      a.rel='noopener noreferrer';
      a.dataset.id=item.id;
      a.setAttribute('draggable', 'true');
      a.addEventListener('dragstart', handleDragStart);
      a.addEventListener('dragend', handleDragEnd);
      a.addEventListener('dragover', handleDragOver);
      a.addEventListener('drop', handleDrop);
      a.setAttribute('data-bs-toggle', 'tooltip');
      a.setAttribute('data-bs-placement', 'top');
      a.setAttribute('data-bs-title', item.link);

      const inner = document.createElement('div');
      inner.className = 'shortcut-inner';

      const menuBtn = document.createElement('button');
      menuBtn.className = 'menu-btn';
      menuBtn.setAttribute('aria-label', 'Open menu');
      menuBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="pointer-events:none;">
          <circle cx="12" cy="5" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="19" r="2"/>
        </svg>
      `;

      const menu=document.createElement('div');
      menu.className='menu';
      menu.innerHTML=`<button data-action="edit">Edit</button><button data-action="delete">Delete</button>`;

      const iconDiv=document.createElement('div');
      iconDiv.className='icon';
      
      const faviconExists = item.favicon_link !== undefined && item.favicon_link !== null;
      const fallbackText = (item.label || '').charAt(0).toUpperCase();

      if (faviconExists) {
        const trimmed = item.favicon_link.trim();

        if (trimmed === "") {
          iconDiv.textContent = fallbackText;
        }
        else if (trimmed === "...") {
          let domain;
          try {
            domain = new URL(item.link).hostname.replace(/^www\./, '');
          } catch {
            domain = '';
          }
          if (domain) {
            const googleFavicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            const img = document.createElement('img');
            img.src = googleFavicon;
            img.alt = item.label || 'Icon';
            img.onload = function() {
              if (/chrome.*\.png$/.test(this.src) || /icons\/product\/chrome/.test(this.src)) {
                iconDiv.innerHTML = fallbackText;
              } else {
                iconDiv.classList.add('has-favicon');
                iconDiv.appendChild(this);
              }
            };
            img.onerror = () => {
              iconDiv.innerHTML = fallbackText;
            };
            iconDiv.textContent = fallbackText;
          } else {
            iconDiv.textContent = fallbackText;
          }
        }
        else {
          const img = document.createElement('img');
          img.src = trimmed;
          img.alt = item.label || 'Icon';
          img.onerror = () => {
            let domain;
            try {
              domain = new URL(item.link).hostname.replace(/^www\./, '');
            } catch {
              domain = '';
            }
            if (domain) {
              const googleFavicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
              const fallbackImg = document.createElement('img');
              fallbackImg.src = googleFavicon;
              fallbackImg.alt = item.label || 'Icon';
              fallbackImg.onload = function() {
                if (/chrome.*\.png$/.test(this.src) || /icons\/product\/chrome/.test(this.src)) {
                  iconDiv.innerHTML = fallbackText;
                } else {
                  iconDiv.classList.add('has-favicon');
                  iconDiv.appendChild(this);
                }
              };
              fallbackImg.onerror = () => {
                iconDiv.innerHTML = fallbackText;
              };
              iconDiv.innerHTML = '';
              iconDiv.appendChild(fallbackImg);
            } else {
              iconDiv.innerHTML = fallbackText;
            }
          };
          iconDiv.classList.add('has-favicon');
          iconDiv.appendChild(img);
        }
      } else {
        iconDiv.textContent = fallbackText;
      }

      if(item.color){
        iconDiv.style.backgroundColor=item.color;
        const hex = item.color.substring(1);
        const r = parseInt(hex.substring(0,2),16);
        const g = parseInt(hex.substring(2,4),16);
        const b = parseInt(hex.substring(4,6),16);
        const isDark = (r*0.299 + g*0.587 + b*0.114)/255 < 0.5;
        iconDiv.style.color = isDark ? '#fff' : '#111';
      }

      const title=document.createElement('div');
      title.className='title';
      title.textContent=item.label||item.link;

      const urlDiv=document.createElement('div');
      urlDiv.className='url';
      urlDiv.textContent=item.link;

      menuBtn.addEventListener('click',ev=>{
        ev.stopPropagation();
        ev.preventDefault();
        closeAllMenus();
        menu.classList.toggle('visible');
      });

      menu.addEventListener('click',ev=>{
        ev.stopPropagation();
        ev.preventDefault();
        const action=ev.target.getAttribute('data-action');
        if(action==='edit') openModalForEdit(item.id);
        else if(action==='delete') if(confirm('Delete this shortcut?')) removeItem(item.id);
        menu.classList.remove('visible');
      });

      document.addEventListener('click',ev=>{
        if(!menu.contains(ev.target) && ev.target!==menuBtn){
          menu.classList.remove('visible');
        }
      });

      inner.appendChild(menuBtn);
      inner.appendChild(menu);
      inner.appendChild(iconDiv);
      inner.appendChild(title);
      inner.appendChild(urlDiv);
      a.appendChild(inner);
      grid.appendChild(a);
    });
    linksContainer.appendChild(titleEl);
    linksContainer.appendChild(grid);
  }
  if(!sortedItems.length){
    const empty=document.createElement('div');
    empty.className='empty';
    empty.textContent='No shortcuts yet. Use + Quick Links to add one.';
    linksContainer.appendChild(empty);
  }
  
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipInstances = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
}

// ======================
// MODAL & CRUD
// ======================
function closeAllMenus(){
  document.querySelectorAll('.menu.visible').forEach(m=>m.classList.remove('visible'));
}

function openModalForAdd(){
  editingId=null;
  modalTitle.textContent='Add Link';
  inputLabel.value=''; 
  inputUrl.value='';
  inputCategory.value='';
  inputFavicon.value='';
  inputColor.value=lastSelectedColor;
  updateCategoryDatalist();
  modalInstance.show();
  setTimeout(() => inputLabel.focus(), 300); 
}

async function openModalForEdit(id){
  await loadAllLinks();
  let item = allLinks.find(x=>x.id==id);
  if(!item){ alert('Item not found'); return; }
  editingId=item.id;
  modalTitle.textContent='Edit Link';
  inputLabel.value=item.label||''; 
  inputUrl.value=item.link||'';
  inputCategory.value=item.category||'';
  inputFavicon.value=item.favicon_link||'';
  inputColor.value=item.color||'#e9e9e9';
  updateCategoryDatalist();
  modalInstance.show();
  setTimeout(() => inputLabel.focus(), 300); 
}

saveBtn.onclick = async () => {
  const label = inputLabel.value.trim(); 
  const link = inputUrl.value.trim();
  const category = inputCategory.value.trim() || 'Uncategorized';
  const color = inputColor.value.trim();
  const favicon_link = inputFavicon.value.trim();

  if(!label || !link){ 
    alert('Please provide both label (name) and URL/Path.');
    return;
  }

  localStorage.setItem('QLinkLastColor', color);
  lastSelectedColor = color;

  const newItem = {label, link, category, color, favicon_link}; 
  
  await loadAllLinks();
  
  if(editingId){
    let existingItem = allLinks.find(x => x.id == editingId);
    if (existingItem) {
        if(existingItem.category !== category) {
          existingItem.category = category;
          const linksInCategory = allLinks.filter(x => x.category === category);
          existingItem.sortOrder = linksInCategory.length; 
        }
        Object.assign(existingItem, newItem);
        allLinks = allLinks; // force reference
    }
  } else {
    let lastId = allLinks.length ? Math.max(...allLinks.map(x=>x.id||0)) : 0;
    newItem.id = lastId + 1;
    const linksInCategory = allLinks.filter(x => x.category === category);
    newItem.sortOrder = linksInCategory.length;
    allLinks.push(newItem);
  }
  
  await saveAllLinks(allLinks);
  modalInstance.hide();
  await renderAll();
  await updateCategoryDatalist();
};

async function removeItem(id){
  allLinks = allLinks.filter(x => x.id !== id);
  await saveAllLinks(allLinks);
  await renderAll();
  await updateCategoryDatalist();
}

// ======================
// EXPORT / IMPORT
// ======================
document.getElementById('exportBtn').onclick = async () => {
  try{
    await loadAllLinks();
    const itemsToExport = allLinks.map(item => ({
        id: item.id,
        label: item.label,
        link: item.link,
        category: item.category,
        color: item.color,
        favicon_link: item.favicon_link,
        sortOrder: item.sortOrder, 
    }));
    
    if(!itemsToExport.length){ alert('No links to export.'); return; }
    const json = JSON.stringify(itemsToExport, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `quicklinks-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }catch(err){
    console.error(err);
    alert('Export failed.');
  }
};

const importFileInput = document.getElementById('importFileInput');
document.getElementById('importBtn').onclick = () => importFileInput.click();
importFileInput.onchange = async ev => {
  const file = ev.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    let imported = JSON.parse(text);
    if(!Array.isArray(imported)){ alert('Invalid format.'); return; }
    if(!confirm(`Import ${imported.length} link(s)?\nNote: This will replace current links.`)) return;
    
    let lastId = 0;
    allLinks = imported.map((item, idx) => {
      const newId = item.id || (1000 + idx);
      lastId = Math.max(lastId, newId);
      return {
        id: newId,
        label: item.label || '',
        link: item.link || '',
        category: item.category || 'Uncategorized',
        color: item.color || '#e9e9e9',
        favicon_link: item.favicon_link || '',
        sortOrder: item.sortOrder ?? 0
      };
    }).filter(x => x.label && x.link);
    
    await saveAllLinks(allLinks);
    await renderAll();
    await updateCategoryDatalist();
    alert(`Imported ${allLinks.length} link(s)!`);
  }catch(err){
    console.error(err);
    alert('Import failed. Check file format.');
  } finally {
    importFileInput.value = '';
  }
};

// ======================
// INIT
// ======================
document.addEventListener('DOMContentLoaded', async () => {
  modalInstance = new bootstrap.Modal(document.getElementById('linkModal'));
  await loadAllLinks();
  await renderAll();
  await updateCategoryDatalist();

  document.getElementById('addHeaderBtn').onclick = e => {
    e.preventDefault();
    openModalForAdd();
  };

  document.addEventListener('keydown', ev=>{
    if(ev.key==='Escape' && modalInstance._isShown) modalInstance.hide();
    if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='k'){
      ev.preventDefault();
      openModalForAdd();
    }
  });
});

async function updateCategoryDatalist() {
  const categories = [...new Set(allLinks.map(x => x.category))].sort((a, b) => a.localeCompare(b));
  const datalist = document.getElementById('categoryList');
  datalist.innerHTML = '';
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    datalist.appendChild(option);
  });
}
</script>

</body>
</html>
