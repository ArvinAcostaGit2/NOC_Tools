<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Quick Links – Dynamic</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  
<style>
    :root{
        --bg:#f5f5f5;
        --card:#fff;
        --muted:#666;
        --accent:#111;
        --shadow:0 2px 5px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        background:var(--bg);
        color:#222;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
    }
    header{
        background:var(--accent);
        color:#fff;
        padding:16px;
    }
    header h1{
        margin:0;
        font-size:18px;
        font-weight:600;
        cursor:pointer;
    }
    .container-custom{
        max-width:1400px;
        margin:20px auto;
        padding:0 16px 60px;
    }
    .section-title{
        font-size:13px;
        font-weight:600;
        margin:6px 0 14px;
        color:var(--muted);
    }
    .shortcut-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill, minmax(120px,1fr));
        gap:16px;
    }
    
    /* === PXE BOOT / LINK CARD ANIMATION STYLES === */
    @keyframes rotateBorder {
        to {
            transform: rotate(1turn);
        }
    }

    .shortcut{
        border-radius:12px;
        box-shadow:var(--shadow);
        text-align:center;
        padding:8px;
        display:block;
        gap:6px;
        text-decoration:none;
        color:inherit;
        position:relative;
        overflow:hidden;
        transition:transform .14s ease, box-shadow .14s ease;
        min-height:125px;
    }

    .shortcut:hover{ 
        transform:translateY(-6px); 
        box-shadow:0 8px 22px rgba(0,0,0,0.16); 
    }
    
    .shortcut::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        z-index: 0;
        opacity: 0; 
        border-radius: inherit;
        background: conic-gradient(
            #ff0000, #ff8c00, #ffff00, #00ff00, #00ffff, #0000ff, #8a2be2, #ff0000
        );
        transition: opacity .3s ease;
    }
    
    .shortcut:hover::before {
        opacity: 1; 
        animation: rotateBorder 3s linear infinite; 
    }
    
    .shortcut-inner {
        position: absolute;
        inset: 2px;
        background: var(--card); 
        border-radius: 10px;
        z-index: 1;
        padding:12px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        gap:8px;
        height: calc(100% - 4px);
    }
    
    .icon{
        width:36px;
        height:36px;
        border-radius:50%;
        background:#e9e9e9;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-size:18px; 
        margin:0 auto;
        color: #111;
        font-weight: 900; 
    }
    .shortcut .title{
        font-size:12px;
        font-weight:500;
        color:#111;
        word-break:break-word;
    }
    .shortcut .url{
        font-size:10px;
        color:var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; 
        width: 100%;
        word-break: break-all;
    }

    .menu-btn{
        position:absolute;
        top:8px;
        right:8px;
        width:30px;
        height:30px;
        border-radius:6px;
        background:transparent;
        border:0;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        opacity:.9;
        z-index:2;
    }

    .menu-btn:hover{ background:rgba(0,0,0,0.04); }
    .menu{
        position:absolute;
        top:36px;
        right:8px;
        background:#fff;
        border-radius:8px;
        box-shadow:0 8px 20px rgba(0,0,0,0.14);
        min-width:120px;
        z-index:30;
        overflow:hidden;
        display:none;
        flex-direction:column;
    }
    .menu.visible{ display:flex; }
    .menu button{
        border:0;
        background:transparent;
        padding:8px 12px;
        text-align:left;
        cursor:pointer;
        width:100%;
        font-size:13px;
    }
    .menu button:hover{ background:rgba(0,0,0,0.04); }
    
    /* Bootstrap Modal Overrides to Match Original Style */
    .modal-content {
        border-radius:12px;
        padding:18px;
        box-shadow:0 20px 60px rgba(0,0,0,0.2);
        border:0;
    }
    .modal-header {
        border:0;
        padding:0 0 10px 0;
    }
    .modal-header h2 {
        margin:0;
        font-size:17px;
    }
    .modal-body {
        padding:8px 0;
    }
    .modal-footer {
        border:0;
        padding:10px 0 0 0;
        justify-content:flex-end;
        gap:8px;
    }
    
    /* Form Styling */
    .form-label{ 
        font-size:12px; 
        color:var(--muted);
        margin-bottom:6px;
    }
    .form-control, .form-select {
        padding:10px 12px;
        border-radius:8px;
        border:1px solid #e2e2e2;
        font-size:14px;
    }
    .form-control:focus, .form-select:focus {
        border-color:#e2e2e2;
        box-shadow:none;
    }
    input[type="color"].form-control{
        height: 38px;
        padding: 0 4px;
    }
    
    /* Button Styling */
    .btn-custom-secondary{ 
        background:#f0f0f0; 
        color:#111;
        border:0;
        padding:8px 12px;
        border-radius:8px;
        font-weight:600;
        font-size:13px;
    }
    .btn-custom-primary{ 
        background:var(--accent); 
        color:#fff;
        border:0;
        padding:8px 12px;
        border-radius:8px;
        font-weight:600;
        font-size:13px;
    }
    .btn-custom-secondary:hover{ 
        background:#e5e5e5; 
        color:#111;
    }
    .btn-custom-primary:hover{ 
        background:#000; 
        color:#fff;
    }
    
    .header-icon-btn{
        background:rgba(255,255,255,0.1);
        border:0;
        border-radius:6px;
        width:36px;
        height:36px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        color:#fff;
        transition:background .2s ease;
    }
    .header-icon-btn:hover{
        background:rgba(255,255,255,0.2);
    }
    .empty{
        padding:26px;
        border-radius:12px;
        background:linear-gradient(180deg,#fff,#fbfbfb);
        text-align:center;
        color:var(--muted);
        box-shadow:var(--shadow);
    }
    
    /* Tooltip styling */
    .tooltip {
        font-size: 12px;
    }
    .tooltip-inner {
        max-width: 300px;
        padding: 6px 10px;
        text-align: left;
        word-break: break-all;
    }
</style>
</head>
<body>
<header>
  <div class="container-fluid">
    <div class="row align-items-center justify-content-between">
      <div class="col-auto">
        <h1 id="addHeaderBtn">+ My Personal Quick Links</h1>
      </div>
      <div class="col-auto">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex gap-2">
            <button id="exportBtn" class="header-icon-btn" title="Export links as JSON">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
              </svg>
            </button>
            <button id="importBtn" class="header-icon-btn" title="Import links from JSON">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
            </button>
          </div>
          <div style="color:#ddd;font-size:13px;">Idea by | Arvin Acosta</div>
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="importFileInput" accept=".json" style="display:none;" />
</header>

<main class="container-custom" role="main">
  <div id="linksContainer"></div>
  <div style="height:18px"></div>
  <div class="text-muted" style="font-size:13px;">Tip: Click a tile to open. Use ⋮ to edit or delete. Changes are saved in IndexedDB.</div>
</main>

<!-- Bootstrap Modal -->
<div class="modal fade" id="linkModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Add Link</h2>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="inputName" class="form-label">Display name</label>
          <input id="inputName" type="text" class="form-control" placeholder="e.g. D1 Registration Form" />
        </div>
        <div class="mb-3">
          <label for="inputUrl" class="form-label">URL or File Path</label>
          <input id="inputUrl" type="text" class="form-control" placeholder="https://example.com or file:///C:/path/to/file.pdf" />
        </div>
        <div class="mb-3">
          <label for="inputCategory" class="form-label">Category</label>
          <input id="inputCategory" type="text" class="form-control" placeholder="e.g. Work, Personal, Shopping, etc." list="categoryList" />
          <datalist id="categoryList">
            <option value="Basic">
            <option value="I. Registration">
            <option value="II. Assessments">
            <option value="III. System Access">
            <option value="IV. TM Surveys">
            <option value="V. Government">
            <option value="VI. Client Websites">
          </datalist>
          <small class="text-muted" style="font-size: 11px;">Type any category name or select from suggestions</small>
        </div>
        <div class="mb-3">
          <label for="inputColor" class="form-label">Icon Background Color (Optional)</label>
          <input id="inputColor" type="color" class="form-control form-control-color w-100" value="#e9e9e9" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelBtn" class="btn btn-custom-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveBtn" class="btn btn-custom-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
  const DB_NAME='myQLinksDB';
  const STORE_NAME='quicklinks';
  const DB_VERSION=1;
  const LS_COLOR_KEY = 'QLinkLastColor';

  let db=null;
  let usingIndexedDB=true;
  let lastSelectedColor = '#e9e9e9';
  let modalInstance = null;
  let tooltipInstances = [];

  async function openDB(){
    if(!('indexedDB' in window)){ usingIndexedDB=false; return; }
    return new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME,DB_VERSION);
      req.onupgradeneeded=ev=>{
        const idb=ev.target.result;
        if(!idb.objectStoreNames.contains(STORE_NAME)){
          const store=idb.createObjectStore(STORE_NAME,{keyPath:'id',autoIncrement:true});
          store.createIndex('name','name',{unique:false});
          store.createIndex('link','link',{unique:false});
          store.createIndex('category','category',{unique:false});
        }
      };
      req.onsuccess=ev=>{ db=ev.target.result; resolve(db); };
      req.onerror=ev=>{ console.error('IndexedDB open error',ev); usingIndexedDB=false; resolve(null); };
    });
  }

  function idbAdd(item){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const store=tx.objectStore(STORE_NAME); const req=store.add(item); req.onsuccess=()=>resolve(req.result); req.onerror=e=>reject(e); }); }
  function idbGetAll(){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE_NAME,'readonly'); const store=tx.objectStore(STORE_NAME); const req=store.getAll(); req.onsuccess=()=>resolve(req.result||[]); req.onerror=e=>reject(e); }); }
  function idbPut(item){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const store=tx.objectStore(STORE_NAME); const req=store.put(item); req.onsuccess=()=>resolve(true); req.onerror=e=>reject(e); }); }
  function idbDelete(id){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const store=tx.objectStore(STORE_NAME); const req=store.delete(id); req.onsuccess=()=>resolve(true); req.onerror=e=>reject(e); }); }

  const LS_KEY='quicklinks_fallback_v1';
  async function lsGetAll(){ const raw=localStorage.getItem(LS_KEY); if(!raw)return[]; try{return JSON.parse(raw);}catch(e){return[];} }
  async function lsSaveAll(arr){ localStorage.setItem(LS_KEY,JSON.stringify(arr)); }

  const linksContainer=document.getElementById('linksContainer');
  const inputName=document.getElementById('inputName');
  const inputUrl=document.getElementById('inputUrl');
  const inputCategory=document.getElementById('inputCategory');
  const inputColor=document.getElementById('inputColor');
  const saveBtn=document.getElementById('saveBtn');
  const modalTitle=document.getElementById('modalTitle');
  let editingId=null;

  // Get unique categories from existing items
  async function getCategories(){
    let items = usingIndexedDB ? await idbGetAll() : await lsGetAll();
    let uniqueCategories = [...new Set(items.map(item => item.category))];
    
    // Sort categories: keep original order for predefined ones, then alphabetically for custom ones
    const predefinedOrder = ['Basic', 'I. Registration', 'II. Assessments', 'III. System Access', 'IV. TM Surveys', 'V. Government', 'VI. Client Websites'];
    
    return uniqueCategories.sort((a, b) => {
      const aIndex = predefinedOrder.indexOf(a);
      const bIndex = predefinedOrder.indexOf(b);
      
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b);
    });
  }

  function getInitialColor() {
    const savedColor = localStorage.getItem(LS_COLOR_KEY);
    if (savedColor) lastSelectedColor = savedColor;
  }

  (async function init(){
    getInitialColor();
    modalInstance = new bootstrap.Modal(document.getElementById('linkModal'));
    await openDB();
    await renderAll();
  })();

  async function renderAll(){
    // Destroy existing tooltips before re-rendering
    tooltipInstances.forEach(tooltip => tooltip.dispose());
    tooltipInstances = [];
    
    let items=usingIndexedDB?await idbGetAll():await lsGetAll();
    let categories = await getCategories();
    
    linksContainer.innerHTML='';
    for(const cat of categories){
      const catItems=items.filter(x=>x.category===cat);
      if(!catItems.length) continue;
      const titleEl=document.createElement('div');
      titleEl.className='section-title';
      titleEl.textContent=cat;
      const grid=document.createElement('div');
      grid.className='shortcut-grid';
      catItems.forEach(item=>{
        const a=document.createElement('a');
        a.className='shortcut';
        a.href=item.link;
        a.target='_blank';
        a.rel='noopener noreferrer';
        a.dataset.id=item.id;
        
        // Add tooltip attributes
        a.setAttribute('data-bs-toggle', 'tooltip');
        a.setAttribute('data-bs-placement', 'top');
        a.setAttribute('data-bs-title', item.link);

        const inner = document.createElement('div');
        inner.className = 'shortcut-inner';

        const menuBtn=document.createElement('button');
        menuBtn.className='menu-btn';
        menuBtn.setAttribute('aria-label','Open menu');
        menuBtn.innerHTML='⋮';

        const menu=document.createElement('div');
        menu.className='menu';
        menu.innerHTML=`<button data-action="edit">Edit</button><button data-action="delete">Delete</button>`;

        const iconDiv=document.createElement('div');
        iconDiv.className='icon';
        iconDiv.textContent=(item.name||'').charAt(0).toUpperCase();

        if(item.color){
          iconDiv.style.backgroundColor=item.color;
          const hex = item.color.substring(1);
          const r = parseInt(hex.substring(0,2),16);
          const g = parseInt(hex.substring(2,4),16);
          const b = parseInt(hex.substring(4,6),16);
          const isDark = (r*0.299 + g*0.587 + b*0.114)/255 < 0.5;
          iconDiv.style.color = isDark ? '#fff' : '#111';
        }

        const title=document.createElement('div');
        title.className='title';
        title.textContent=item.name||item.link;

        const urlDiv=document.createElement('div');
        urlDiv.className='url';
        urlDiv.textContent=item.link;

        menuBtn.addEventListener('click',ev=>{
          ev.stopPropagation();
          ev.preventDefault();
          closeAllMenus();
          menu.classList.toggle('visible');
        });

        menu.addEventListener('click',ev=>{
          ev.stopPropagation();
          ev.preventDefault();
          const action=ev.target.getAttribute('data-action');
          if(action==='edit') openModalForEdit(item.id);
          else if(action==='delete') if(confirm('Delete this shortcut?')) removeItem(item.id);
          menu.classList.remove('visible');
        });

        document.addEventListener('click',ev=>{
          if(!menu.contains(ev.target) && ev.target!==menuBtn){
            menu.classList.remove('visible');
          }
        });

        inner.appendChild(menuBtn);
        inner.appendChild(menu);
        inner.appendChild(iconDiv);
        inner.appendChild(title);
        inner.appendChild(urlDiv);
        a.appendChild(inner);
        grid.appendChild(a);
      });
      linksContainer.appendChild(titleEl);
      linksContainer.appendChild(grid);
    }
    if(!items.length){
      const empty=document.createElement('div');
      empty.className='empty';
      empty.textContent='No shortcuts yet. Use + Quick Links to add one.';
      linksContainer.appendChild(empty);
    }
    
    // Initialize tooltips for all link cards
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipInstances = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
  }

  function closeAllMenus(){
    document.querySelectorAll('.menu.visible').forEach(m=>m.classList.remove('visible'));
  }

  function openModalForAdd(){
    editingId=null;
    modalTitle.textContent='Add Link';
    inputName.value='';
    inputUrl.value='';
    inputCategory.value='';
    inputColor.value=lastSelectedColor;
    modalInstance.show();
    setTimeout(() => inputName.focus(), 300);
  }

  async function openModalForEdit(id){
    let items = usingIndexedDB ? await idbGetAll() : await lsGetAll();
    let item = items.find(x=>x.id==id);
    if(!item){ alert('Item not found'); return; }
    editingId=item.id;
    modalTitle.textContent='Edit Link';
    inputName.value=item.name||'';
    inputUrl.value=item.link||'';
    inputCategory.value=item.category||'';
    inputColor.value=item.color||'#e9e9e9';
    modalInstance.show();
    setTimeout(() => inputName.focus(), 300);
  }

  saveBtn.onclick = async () => {
    const name = inputName.value.trim();
    const link = inputUrl.value.trim();
    const category = inputCategory.value.trim() || 'Uncategorized';
    const color = inputColor.value.trim();

    if(!name || !link){
      alert('Please provide both name and URL/Path.');
      return;
    }

    localStorage.setItem(LS_COLOR_KEY, color);
    lastSelectedColor = color;

    const item = {name, link, category, color};
    if(editingId){
      item.id = editingId;
      usingIndexedDB ? await idbPut(item) : await (async()=>{
        let arr = await lsGetAll();
        let i = arr.findIndex(x=>x.id==editingId);
        if(i>-1) arr[i] = {...arr[i], ...item};
        await lsSaveAll(arr);
      })();
    } else {
      usingIndexedDB ? await idbAdd(item) : await (async()=>{
        let arr = await lsGetAll();
        let lastId = arr.length ? Math.max(...arr.map(x=>x.id||0)) : 0;
        arr.push({id:lastId+1, ...item});
        await lsSaveAll(arr);
      })();
    }
    modalInstance.hide();
    await renderAll();
  };

  async function removeItem(id){
    usingIndexedDB ? await idbDelete(id) : await (async()=>{
      let arr = await lsGetAll();
      arr = arr.filter(x=>x.id!=id);
      await lsSaveAll(arr);
    })();
    await renderAll();
  }

  document.addEventListener('keydown', ev=>{
    if(ev.key==='Escape') modalInstance.hide();
    if((ev.ctrlKey||ev.metaKey) && ev.key.toLowerCase()==='k'){
      ev.preventDefault();
      openModalForAdd();
    }
  });

  document.getElementById('addHeaderBtn').onclick = e => {
    e.preventDefault();
    openModalForAdd();
  };

  // EXPORT
  document.getElementById('exportBtn').onclick = async () => {
    try{
      const items = usingIndexedDB ? await idbGetAll() : await lsGetAll();
      if(!items.length){ alert('No links to export.'); return; }
      const json = JSON.stringify(items, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `quicklinks-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }catch(err){
      console.error(err);
      alert('Export failed.');
    }
  };

  // IMPORT
  const importFileInput = document.getElementById('importFileInput');
  document.getElementById('importBtn').onclick = () => importFileInput.click();
  importFileInput.onchange = async ev => {
    const file = ev.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      let imported = JSON.parse(text);
      if(!Array.isArray(imported)){ alert('Invalid format.'); return; }
      if(!confirm(`Import ${imported.length} link(s)?`)) return;

      for(const item of imported){
        const newItem = {
          name: item.name || '',
          link: item.link || '',
          category: item.category || 'Uncategorized',
          color: item.color || '#e9e9e9'
        };
        if(!newItem.name || !newItem.link) continue;
        usingIndexedDB ? await idbAdd(newItem) : await (async()=>{
          let arr = await lsGetAll();
          let lastId = arr.length ? Math.max(...arr.map(x=>x.id||0)) : 0;
          arr.push({id:lastId+1, ...newItem});
          await lsSaveAll(arr);
        })();
      }
      await renderAll();
      alert(`Imported ${imported.length} link(s)!`);
    }catch(err){
      console.error(err);
      alert('Import failed. Check file format.');
    } finally {
      importFileInput.value = '';
    }
  };
</script>
</body>
</html>
