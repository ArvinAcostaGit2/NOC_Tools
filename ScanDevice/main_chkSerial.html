<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search or Scan Serial Number</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="static/assets/js/html5-qrcode.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* move upward */
      height: 100vh;
      margin: 0;
      padding-top: 60px; /* adds some space from top */
    }

    .frosted-glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
      width: 360px;
      padding: 30px;
      text-align: center;
    }
    
    /* NEW: Custom Header Style */
    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .app-header h3 {
        margin: 0;
    }
    
    /* NEW: Database Button Style */
    #dbInfoBtn {
        background: none;
        border: none;
        color: #0dfd19; /* Primary color */
        padding: 0;
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        line-height: 1;
        cursor: pointer;
        transition: color 0.2s;
    }
    #dbInfoBtn:hover {
        color: #f7f305;
    }
    #dbInfoBtn i {
        font-size: 1.5rem;
    }
    #currentDbName {
        font-size: 0.6rem;
        margin-top: 2px;
        font-weight: bold;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    /* END NEW STYLES */

    input,
    textarea,
    select {
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }

    input:focus,
    textarea:focus,
    select:focus {
      background-color: #444;
      outline: none;
    }

    .btn-primary {
      background-color: #0d6efd;
      border: none;
    }

    .btn-primary:hover {
      background-color: #0b5ed7;
    }
    
    .btn-danger-custom {
      background-color: #dc3545;
      color: #fff;
      border: none;
    }
    .btn-danger-custom:hover {
        background-color: #c82333;
        color: #fff;
    }
    
    .btn-success-custom {
      background-color: #28a745;
      color: #fff;
      border: none;
    }
    .btn-success-custom:hover {
        background-color: #1e7e34;
        color: #fff;
    }


    .modal-content {
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 10px;
    }
    
    /* CSS for Floating Button - REMOVED */


    .modal-header,
    .modal-footer {
      border-color: #444;
    }

    .close-btn {
      float: right;
      cursor: pointer;
      color: #ff4444;
      font-weight: bold;
    }

    .qr-container {
      text-align: center;
    }

    #qr-reader {
      margin-top: 10px;
      border-radius: 10px;
      overflow: hidden;
    }

    .info-label {
      color: #0d6efd;
    }
    
    /* Style for DB list in modal */
    #dbListContainer .list-group-item {
        border-color: #444;
        background-color: #333; /* Darker background for list items */
        margin-bottom: 5px;
        border-radius: 5px;
    }
  </style>
</head>

<body>
  <div class="frosted-glass">
    <div class="app-header">
        <h3>Serial Scanner</h3>
        <button id="dbInfoBtn" title="Change Database" data-bs-toggle="tooltip" data-bs-placement="bottom">
            <i class="fas fa-database"></i>
            <span id="currentDbName">Loading...</span>
        </button>
    </div>
    <input
      type="text"
      id="searchInput"
      class="form-control mb-3"
      placeholder="Enter or Scan Serial Number"
    />
    <button class="btn btn-primary w-100 mb-2" id="searchBtn">
      Search / Scan
    </button>
  </div>

  <div class="modal fade" id="dbSelectionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Database Selection</h5>
        </div>
        <div class="modal-body">
            <p>The **Serial Scanner** uses the **`CSVRecords`** data store inside an **IndexedDB** database. Please select the database you wish to use for lookups:</p>
            <div id="dbListContainer" class="list-group">
                <p class="text-secondary">Loading available databases...</p>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary w-100" id="useDbBtn" disabled>Use Selected Database</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Device Information</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer d-flex justify-content-center">
          <button
            type="button"
            class="btn btn-success-custom mx-2"
            id="modalClearAndScanBtn"
          >
            Clear & Scan
          </button>
          <button
            type="button"
            class="btn btn-secondary mx-2"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="clearConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title">Clear Input?</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body text-center">
          Do you want to clear the serial number from the input field?
        </div>
        <div class="modal-footer border-0 d-flex justify-content-between">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Keep
          </button>
          <button
            type="button"
            class="btn btn-success-custom"
            id="clearAndScanBtn"
          >
            Clear & Scan
          </button>
          <button
            type="button"
            class="btn btn-danger-custom"
            id="confirmClearBtn"
          >
            Clear Only
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="scannerModal"
    tabindex="-1"
    aria-hidden="true"
    data-bs-backdrop="static"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content text-center">
        <div class="modal-header">
          <h5 class="modal-title">Scan Serial Number</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
            id="closeScannerBtn"
          ></button>
        </div>
        <div class="modal-body qr-container">
          <div id="qr-reader" style="width: 100%"></div>
        </div>
      </div>
    </div>
  </div>
  
  <audio id="beep-sound" src="static/assets/audio/beep.mp3" preload="auto"></audio>
  <audio id="triple-beep" src="static/assets/audio/3beep.mp3" preload="auto"></audio>
  <audio id="cancel-sound" src="static/assets/audio/cancel2.mp3" preload="auto"></audio>

  <script>
    // --- GLOBAL VARIABLES AND CONSTANTS ---
    let db = null; 
    let currentDbName = 'Loading...';
    const DB_STORAGE_KEY = 'selectedIndexedDB';
    const DEFAULT_OBJECT_STORE = 'CSVRecords';
    const DEFAULT_DB_NAME = 'CSVStorageDB'; // Use a consistent default

    
    // --- ELEMENT REFERENCES ---
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const resultModalEl = document.getElementById("resultModal");
    const clearConfirmModalEl = document.getElementById("clearConfirmModal");
    const confirmClearBtn = document.getElementById("confirmClearBtn");
    const clearAndScanBtn = document.getElementById("clearAndScanBtn");
    // NEW: Reference for the new button in result modal
    const modalClearAndScanBtn = document.getElementById("modalClearAndScanBtn");

    // DB Selection Elements
    const dbSelectionModalEl = document.getElementById("dbSelectionModal");
    const dbListContainer = document.getElementById("dbListContainer");
    const useDbBtn = document.getElementById("useDbBtn");
    const dbInfoBtn = document.getElementById("dbInfoBtn");
    const currentDbNameSpan = document.getElementById("currentDbName");
    
    // --- AUDIO HELPER FUNCTION ---
    function playSound(audioId) {
        const audio = document.getElementById(audioId);
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
            audio.play().catch(e => console.error("Error playing sound:", e));
        }
    }

    // --- DATABASE SELECTION AND CONNECTION LOGIC ---

    function updateDbDisplay(name) {
        currentDbName = name;
        currentDbNameSpan.textContent = name;
        dbInfoBtn.title = `Current Database: ${name}`;
    }

    // Function to connect to IndexedDB
    function connectToDb(dbName) {
        if (!dbName) {
            console.error("No database name provided.");
            return;
        }
        
        if (db) {
            db.close();
            db = null;
        }

        updateDbDisplay(dbName);
        
        // Use version 1, as that is what is used to create the store
        const openReq = indexedDB.open(dbName, 1);
        
        // IMPORTANT: This handles the case where the database is new or needs the store
        openReq.onupgradeneeded = (e) => {
            const tempDb = e.target.result;
            if (!tempDb.objectStoreNames.contains(DEFAULT_OBJECT_STORE)) {
                console.log(`Creating object store: ${DEFAULT_OBJECT_STORE} in database: ${dbName}`);
                // Ensure the object store is created here
                tempDb.createObjectStore(DEFAULT_OBJECT_STORE, { keyPath: "id", autoIncrement: true });
            }
        };

        openReq.onsuccess = (e) => {
            db = e.target.result;
            console.log(`Successfully connected to IndexedDB: ${dbName}`);
            
            const dbModal = bootstrap.Modal.getInstance(dbSelectionModalEl);
            if (dbModal) dbModal.hide();
            
            localStorage.setItem(DB_STORAGE_KEY, dbName);
            updateDbDisplay(dbName);
        };
        
        openReq.onerror = (e) => {
            console.error("DB connection error:", e);
            updateDbDisplay('ERROR');
            alert(`Failed to connect to database: ${dbName}. Error: ${e.target.error.name}. Please select a different one.`);
            showDbSelectionModal();
        };
    }

    // Function to fetch available DBs
    function getAvailableDatabases() {
        if (!window.indexedDB || !indexedDB.databases) {
            dbListContainer.innerHTML = `<p class="text-warning">Browser limitation: Cannot list databases. Defaulting to: **${DEFAULT_DB_NAME}**.</p>`;
            useDbBtn.disabled = false;
            useDbBtn.textContent = `Use Default (${DEFAULT_DB_NAME})`;
            useDbBtn.dataset.dbName = DEFAULT_DB_NAME;
            return;
        }
        
        indexedDB.databases().then(databases => {
            populateDbSelectionModal(databases);
        }).catch(error => {
            dbListContainer.innerHTML = '<p class="text-danger">Error listing databases. Try refreshing.</p>';
            console.error("Error listing databases:", error);
        });
    }

    // Function to populate the modal with options
    function populateDbSelectionModal(databases) {
        dbListContainer.innerHTML = '';
        const savedDbName = localStorage.getItem(DB_STORAGE_KEY);
        let defaultChecked = false;
        
        // Add default option if no databases exist
        if (databases.length === 0) {
            databases.push({name: DEFAULT_DB_NAME, version: 1});
            dbListContainer.innerHTML = `<p class="text-info">No IndexedDB databases found. Creating **${DEFAULT_DB_NAME}** on connect.</p>`;
        }


        databases.forEach((dbInfo, index) => {
            const dbName = dbInfo.name;
            const isChecked = dbName === savedDbName || (dbName === DEFAULT_DB_NAME && !savedDbName && databases.length === 1);
            if (isChecked) defaultChecked = true;
            
            const div = document.createElement('div');
            div.className = 'form-check list-group-item bg-dark text-light';
            
            div.innerHTML = `
                <input class="form-check-input" type="radio" name="dbRadio" id="db-${index}" value="${dbName}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="db-${index}">
                    ${dbName}
                </label>
            `;
            dbListContainer.appendChild(div);
        });
        
        useDbBtn.disabled = !defaultChecked;
        useDbBtn.textContent = 'Use Selected Database';

        // Listen for changes in radio buttons (only works if list is populated)
        dbListContainer.querySelectorAll('input[name="dbRadio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                useDbBtn.disabled = false;
            });
        });
    }

    // Function to show the modal
    function showDbSelectionModal() {
        const dbModal = new bootstrap.Modal(dbSelectionModalEl, {
            backdrop: 'static',
            keyboard: false
        });
        getAvailableDatabases();
        dbModal.show();
    }
    
    // Event listeners for DB interaction
    useDbBtn.addEventListener('click', () => {
        const selectedRadio = document.querySelector('input[name="dbRadio"]:checked');
        let dbName = selectedRadio ? selectedRadio.value : useDbBtn.dataset.dbName; 
        
        if (dbName) {
            connectToDb(dbName);
        } else {
            alert("Please select a database.");
        }
    });

    dbInfoBtn.addEventListener('click', () => {
        showDbSelectionModal();
    });

    // --- EXISTING FUNCTIONS ---

    searchBtn.addEventListener("click", () => {
      const val = searchInput.value.trim();
      if (val) searchSerial(val);
      else startScanner();
    });

    function searchSerial(serial) {
      if (!db) {
        alert("Database is not connected. Please select a database first.");
        showDbSelectionModal();
        return;
      }
      
      // Check if the object store exists in the current DB
      if (!db.objectStoreNames.contains(DEFAULT_OBJECT_STORE)) {
        alert(`Error: The selected database "${currentDbName}" does not contain the required object store "${DEFAULT_OBJECT_STORE}". Please select a different database, or try re-connecting to create it.`);
        // Note: The onupgradeneeded in connectToDb should handle creation, but this acts as a runtime check.
        showDbSelectionModal();
        return;
      }

      const tx = db.transaction([DEFAULT_OBJECT_STORE], "readonly");
      const store = tx.objectStore(DEFAULT_OBJECT_STORE);
      const req = store.openCursor();
      let found = false;

      req.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
          const rec = cursor.value;
          if (
            rec.serial_number &&
            rec.serial_number.trim().toUpperCase() === serial.trim().toUpperCase()
          ) {
            found = true;
            
            // --- SOUND LOGIC FOR SEARCH SUCCESS ---
            const totalRamText = rec.total_ram ? rec.total_ram.toUpperCase() : '0GB';
            let totalRam = 0;
            const match = totalRamText.match(/(\d+(\.\d+)?)\s*GB/i);
            if (match) {
                totalRam = parseFloat(match[1]);
            }

            if (totalRam > 0 && totalRam <= 8) {
                // Triple beep for successful find AND RAM is 8GB or less
                playSound('triple-beep'); 
            } else {
                // Standard beep for successful find (RAM > 8GB or RAM field non-specific/missing)
                playSound('beep-sound');
            }
            // ----------------------------------------

            showModal(rec);
            return;
          }
          cursor.continue();
        } else if (!found) {
          alert("Serial Number does not exist");
        }
      };
      
      req.onerror = (e) => {
        console.error("Search error:", e);
        alert("An error occurred during search. Check console for details.");
      };
    }

    function showModal(d) {
      const body = document.getElementById("modalBody");
      body.innerHTML = `
        <p><span class="info-label">Hostname:</span> ${d.hostname || 'N/A'}</p>
        <p><span class="info-label">Serial Number:</span> ${d.serial_number || 'N/A'}</p> 

        <p><span class="info-label">Floor:</span> ${d.floor || 'N/A'}</p>
        <p><span class="info-label">Loc1:</span> ${d.loc1 || 'N/A'}</p>
        <p><span class="info-label">Loc2:</span> ${d.loc2 || 'N/A'}</p>

        <p><span class="info-label">Model:</span> ${d.model || 'N/A'}</p>
        
        <p><span class="info-label">Total RAM:</span> ${d.total_ram || 'N/A'}</p>
        <p><span class="info-label">RAM per Slot:</span> ${d.ram_per_slot || 'N/A'}</p>
        <p><span class="info-label">RAM Type:</span> ${d.ram_type || 'N/A'}</p>

      `;
      const modal = new bootstrap.Modal(resultModalEl);
      modal.show();
    }

    /* ---- QR SCANNER LOGIC ---- */
    let html5QrCode = null;

    function startScanner() {
      const scanModal = new bootstrap.Modal(document.getElementById("scannerModal"));
      scanModal.show();

      html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode
        .start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (txt) => handleQrScan(txt, scanModal),
          (err) => console.log("scan error:", err)
        )
        .catch((err) => console.error("QR start error", err));
    }

    function handleQrScan(txt, scanModal) {
      stopScanner();
      scanModal.hide();

      // Clean scanned text
      const cleanText = txt.trim().replace(/[\r\n]+/g, "").replace(/^"|"$/g, "");
      searchInput.value = cleanText;
      
      // Sound is handled in searchSerial based on the result
      searchSerial(cleanText);
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode
          .stop()
          .then(() => (html5QrCode = null))
          .catch((err) => console.error("stop error:", err));
      }
    }

    document
      .getElementById("closeScannerBtn")
      .addEventListener("click", () => {
          stopScanner();
          // Play cancel sound when scanner is manually closed
          playSound('cancel-sound'); 
      });

    // NEW: Handle the Clear & Scan button click inside the result modal
    modalClearAndScanBtn.addEventListener('click', function() {
        searchInput.value = ''; // Clear the input field
        const resultModal = bootstrap.Modal.getInstance(resultModalEl);
        if (resultModal) {
            resultModal.hide(); // Hide the device info modal
        }
        startScanner(); // Immediately start scanning
    });

    /* ---- INPUT CLEAR Confirmation Modal Logic ---- */

    // 1. Show the clear confirmation modal when the result modal closes
    // IMPORTANT: This logic is updated to prevent showing the confirmation modal
    // IF the new "Clear & Scan" button was the one that closed the modal.
    let bypassClearConfirm = false;

    // We detect the bypass before the modal closes
    modalClearAndScanBtn.addEventListener('mousedown', function() {
        bypassClearConfirm = true;
    });
    
    // We reset the flag and check if the confirmation should run when the modal is hidden
    resultModalEl.addEventListener('hidden.bs.modal', function () {
      if (!bypassClearConfirm && searchInput.value.trim() !== '') {
        const confirmModal = new bootstrap.Modal(clearConfirmModalEl);
        confirmModal.show();
      }
      bypassClearConfirm = false; // Reset the flag
    });

    // 2. Clear ONLY the input field when the "Clear Only" button is clicked
    confirmClearBtn.addEventListener('click', function() {
        searchInput.value = '';
        const confirmModal = bootstrap.Modal.getInstance(clearConfirmModalEl);
        confirmModal.hide();
    });
    
    // 3. Clear the input and immediately start the scanner
    clearAndScanBtn.addEventListener('click', function() {
        searchInput.value = '';
        const confirmModal = bootstrap.Modal.getInstance(clearConfirmModalEl);
        confirmModal.hide();
        startScanner(); // Call the scanning function
    });
    
    // --- INITIALIZATION ---
    window.onload = function() {
        // 1. Determine which DB to use
        const savedDbName = localStorage.getItem(DB_STORAGE_KEY);
        
        if (savedDbName) {
            connectToDb(savedDbName);
        } else {
            // Display placeholder name before selection
            updateDbDisplay('Select DB');
            showDbSelectionModal();
        }
    };

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
