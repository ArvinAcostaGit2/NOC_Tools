<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CLEARANCE</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #4a90e2;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --purple: #6f42c1;
      --border: #ddd;
      --bg-alt: #f9f9f9;
      --text: #333;
      --radius: 4px;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #fff;
      color: var(--text);
    }
    .container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .left-panel {
      flex: 2;
    }
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-family: monospace;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      padding: 6px 8px;
      line-height: 1.5;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      transition: border 0.2s ease;
    }
    input[type="text"]:focus {
      border: 1px solid var(--primary);
      outline: none;
      background-color: #fff;
    }
    input[type="text"]:disabled {
      background-color: #f5f5f5;
      color: #666;
      cursor: not-allowed;
    }
    button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      margin: 2px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
    }
    .btn { background-color: var(--primary); color: white; }
    .btn:hover:not(:disabled) { background-color: #357abd; }
    .clear-btn { background-color: var(--danger); }
    .clear-btn:hover:not(:disabled) { background-color: #c82333; }
    .export-btn { background-color: var(--success); }
    .export-btn:hover:not(:disabled) { background-color: #218838; }
    .save-btn { background-color: var(--info); }
    .save-btn:hover:not(:disabled) { background-color: #138496; }
    .edit-btn { background-color: #fd7e14; }
    .edit-btn:hover:not(:disabled) { background-color: #e76a00; }
    .delete-btn { background-color: var(--danger); }
    .delete-btn:hover:not(:disabled) { background-color: #c82333; }
    .add-btn { background-color: var(--purple); }
    .add-btn:hover:not(:disabled) { background-color: #5a32a3; }
    .open-modal-btn { background-color: #007bff; }
    .open-modal-btn:hover:not(:disabled) { background-color: #0056b3; }
    .export-json-btn { background-color: var(--warning); color: #212529; }
    .export-json-btn:hover:not(:disabled) { background-color: #e0a800; }

    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    .error-message {
      color: red;
      font-weight: bold;
      margin-left: 10px;
      font-size: 0.8rem;
    }
    .error-input {
      border: 1px solid red !important;
      background-color: #ffe6e6;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .action-cell {
      text-align: center;
      white-space: nowrap;
    }
    .account-entry {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 5px;
      margin-bottom: 5px;
      padding: 3px;
      border-bottom: 1px solid #eee;
    }
    .account-entry:last-child {
      border-bottom: none;
    }
    .account-entry input {
      flex: 1;
      margin: 0;
      font-size: 0.85rem;
      padding: 4px 6px;
    }
    .account-entry .action-buttons {
      display: flex;
      gap: 4px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal.show {
      display: block;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 0;
      border: none;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .modal-header {
      background-color: #007bff;
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.3em;
    }
    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    .close:hover {
      color: #ccc;
    }
    .modal-body {
      padding: 16px;
      max-height: calc(80vh - 100px);
      overflow-y: auto;
    }
    .table-container {
      overflow-x: auto;
      border-radius: 5px;
      border: 1px solid var(--border);
    }
    .modal table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    .modal th, .modal td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
      font-size: 0.85rem;
    }
    .modal th {
      background-color: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .modal tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .modal tbody tr:hover {
      background-color: #e8f4fd;
    }
    .no-data {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
    .data-info {
      margin-bottom: 12px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
      font-size: 0.9rem;
      color: #495057;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .data-info button {
      width: 20%;
      font-size: 0.85rem;
      padding: 6px 10px;
      margin-left: 20px;
    }
    .ticket-info {
      margin: 16px 0 8px;
      padding: 10px;
      background-color: #e7f3ff;
      border: 1px solid #b8daff;
      border-radius: var(--radius);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <h2>IT-NOC Clearance - Program Account Deactivation Log</h2>
  <div class="container">
    <!-- Left: Textarea -->
    <div class="left-panel">
      <textarea id="csvInput" placeholder="Paste data like: 435011,Acuyan1,Merijoy1,PAYPAL"></textarea>
      <div class="button-container">
        <button id="generateBtn" class="btn" disabled>Generate Table</button>
        <button id="viewStoredBtn" class="open-modal-btn">View Stored Data</button>
        <button id="exportBtn" class="export-btn">Export to CSV</button>
        <button id="clearStorageBtn" class="clear-btn">Clear Database</button>
      </div>
    </div>
    <!-- Right: Form Inputs -->
    <div class="right-panel">
      <div>
        <label for="ticketNumber">Ticket Number</label>
        <input type="text" id="ticketNumber" placeholder="e.g., INC123456" />
      </div>
      <div>
        <label for="processedBy">Processed By</label>
        <input type="text" id="processedBy" placeholder="Your name" />
      </div>
    </div>
  </div>
  <div id="tableContainer"></div>

  <!-- Modal -->
  <div id="clearanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Clearance Table Data</h2>
        <span class="close" onclick="closeModal()">Ã—</span>
      </div>
      <div class="modal-body">
        <div class="data-info" id="dataInfo">Loading data...</div>
        <div class="table-container">
          <table id="clearanceTable">
            <thead>
              <tr>
                <th>Ticket Number</th>
                <th>EID</th>
                <th>LastName</th>
                <th>FirstName</th>
                <th>Program</th>
                <th>Accounts</th>
                <th>Processed By</th>
                <th>Date Stamp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DB_NAME = 'ClearanceDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'entries';
    let db;

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = event => {
          db = event.target.result;
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          store.createIndex('eid', 'eid', { unique: false });
          store.createIndex('ticketNumber', 'ticketNumber', { unique: false });
        };
        request.onsuccess = event => {
          db = event.target.result;
          resolve(db);
        };
        request.onerror = event => {
          console.error('Error opening IndexedDB:', event.target.error);
          reject(event.target.error);
        };
      });
    }

    function saveToDB(data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put(data);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    function deleteFromDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    function clearDB() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    function fetchAllData() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function fetchByEids(eids) {
      const all = await fetchAllData();
      return all.filter(r => eids.includes(r.eid));
    }

    function XexportToJSON() {
      fetchAllData()
        .then(data => {
          if (data.length === 0) return alert('No data to export.');
          const grouped = data.reduce((acc, r) => {
            const key = r.ticketNumber || 'Unknown';
            if (!acc[key]) {
              acc[key] = { ticketNumber: key, date: r.dateStamp, processedBy: r.processedBy, entries: [] };
            }
            let entry = acc[key].entries.find(e => e.eid === r.eid && e.lastName === r.lastName && e.firstName === r.firstName && e.program === r.program);
            if (!entry) {
              entry = { eid: r.eid, lastName: r.lastName, firstName: r.firstName, program: r.program, accounts: [] };
              acc[key].entries.push(entry);
            }
            entry.accounts.push(r.accounts);
            return acc;
          }, {});
          const jsonData = Object.values(grouped).sort((a, b) => a.ticketNumber.localeCompare(b.ticketNumber));
          const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `clearance_data_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          alert('Exported to JSON!');
        })
        .catch(err => alert('Export failed: ' + err.message));
    }

function exportToJSON() {
  fetchAllData()
    .then(data => {
      if (data.length === 0) return alert('No data to export.');

      // Group by ticket number
      const grouped = data.reduce((acc, r) => {
        const key = r.ticketNumber || 'Unknown';
        if (!acc[key]) {
          acc[key] = { ticketNumber: key, date: r.dateStamp, processedBy: r.processedBy, entries: [] };
        }
        let entry = acc[key].entries.find(e => 
          e.eid === r.eid && 
          e.lastName === r.lastName && 
          e.firstName === r.firstName && 
          e.program === r.program
        );
        if (!entry) {
          entry = { eid: r.eid, lastName: r.lastName, firstName: r.firstName, program: r.program, accounts: [] };
          acc[key].entries.push(entry);
        }
        entry.accounts.push(r.accounts);
        return acc;
      }, {});

      const jsonData = Object.values(grouped).sort((a, b) => a.ticketNumber.localeCompare(b.ticketNumber));

      // Use first record's ticketNumber + processedBy
      const firstRecord = data[0];
      const ticket = (firstRecord.ticketNumber || 'Unknown').replace(/[^a-zA-Z0-9]/g, '_');
      const user = (firstRecord.processedBy || 'Unknown').replace(/[^a-zA-Z0-9]/g, '_');

      const filename = `${ticket}_${user}.json`;

      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);

      alert(`Exported as: ${filename}`);
    })
    .catch(err => alert('Export failed: ' + err.message));
}




    document.addEventListener('DOMContentLoaded', function() {
      const els = {
        csvInput: document.getElementById('csvInput'),
        generateBtn: document.getElementById('generateBtn'),
        viewStoredBtn: document.getElementById('viewStoredBtn'),
        exportBtn: document.getElementById('exportBtn'),
        clearStorageBtn: document.getElementById('clearStorageBtn'),
        ticketNumber: document.getElementById('ticketNumber'),
        processedBy: document.getElementById('processedBy'),
        tableContainer: document.getElementById('tableContainer')
      };

      function checkGenerateButton() {
        const valid = els.ticketNumber.value.trim() && els.processedBy.value.trim();
        els.generateBtn.disabled = !valid;
      }
      els.ticketNumber.addEventListener('input', checkGenerateButton);
      els.processedBy.addEventListener('input', checkGenerateButton);
      checkGenerateButton();

      els.viewStoredBtn.addEventListener('click', openModal);

      els.clearStorageBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
          clearDB()
            .then(() => {
              alert('Database cleared successfully!');
              if (document.getElementById('clearanceModal').classList.contains('show')) {
                openModal();
              }
            })
            .catch(err => {
              console.error('Clear failed:', err);
              alert('Error: ' + err.message);
            });
        }
      });

      els.exportBtn.addEventListener('click', () => alert('CSV export coming soon!'));

      els.generateBtn.addEventListener('click', async () => {
        try {
          const csv = els.csvInput.value.trim();
          const ticket = els.ticketNumber.value.trim();
          const processedBy = els.processedBy.value.trim();
          if (!csv) {
            alert('Please paste data in the textarea.');
            return;
          }
          const lines = csv.split('\n').map(l => l.trim()).filter(Boolean);
          const eids = lines.map(l => l.split(',')[0]?.trim()).filter(Boolean);
          let existingRecords = [];
          if (eids.length > 0) {
            existingRecords = await fetchByEids(eids);
          }
          const existingMap = existingRecords.reduce((map, r) => {
            if (!map[r.eid]) map[r.eid] = [];
            map[r.eid].push(r.accounts);
            return map;
          }, {});
          const table = document.createElement('table');
          const header = table.insertRow();
          ['EID', 'LastName', 'FirstName', 'Program', 'Accounts', 'Action'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            header.appendChild(th);
          });
          lines.forEach(line => {
            const [eid, lastName, firstName, program] = line.split(',').map(s => s.trim());
            const savedAccounts = existingMap[eid] || [];
            table.appendChild(createRow({ eid, lastName, firstName, program }, savedAccounts, ticket, processedBy));
          });
          const ticketInfo = document.createElement('div');
          ticketInfo.className = 'ticket-info';
          ticketInfo.innerHTML = `<strong>Ticket:</strong> ${ticket} | <strong>Processed By:</strong> ${processedBy}`;
          els.tableContainer.innerHTML = '';
          els.tableContainer.appendChild(ticketInfo);
          els.tableContainer.appendChild(table);
        } catch (err) {
          console.error('Generate failed:', err);
          alert('Error generating table: ' + err.message);
        }
      });

      function createRow(rowData, savedAccounts, ticket, processedBy) {
        const tr = document.createElement('tr');
        const rowId = crypto.randomUUID();
        tr.appendChild(createCell(rowData.eid));
        tr.appendChild(createCell(rowData.lastName));
        tr.appendChild(createCell(rowData.firstName));
        tr.appendChild(createCell(rowData.program));
        tr.appendChild(createAccountsCell(rowId, rowData, savedAccounts, ticket, processedBy));
        tr.appendChild(createActionCell(rowId, rowData, tr));
        return tr;
      }

      function createCell(text) {
        const td = document.createElement('td');
        td.textContent = text || '';
        return td;
      }

      function createAccountsCell(rowId, rowData, savedAccounts, ticket, processedBy) {
        const td = document.createElement('td');
        td.className = 'action-cell';
        const container = document.createElement('div');
        container.className = 'account-entries';
        savedAccounts.forEach(acc => {
          container.appendChild(createAccountEntry(rowId, rowData, acc, ticket, processedBy, true));
        });
        container.appendChild(createAccountEntry(rowId, rowData, '', ticket, processedBy, false));
        td.appendChild(container);
        return td;
      }

      function createAccountEntry(rowId, rowData, accountValue, ticket, processedBy, isSaved) {
        const entryId = isSaved ? `${accountValue}_${rowData.eid}_${Date.now()}` : crypto.randomUUID();
        const entry = document.createElement('div');
        entry.className = 'account-entry';
        entry.dataset.entryId = entryId;
        entry.dataset.isSaved = isSaved;
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Enter account (domain or email)';
        input.value = accountValue;
        if (isSaved) input.disabled = true;

        const buttons = document.createElement('div');
        buttons.className = 'action-buttons';

        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.innerHTML = '<i class="bi bi-save"></i>';
        saveBtn.style.display = isSaved ? 'none' : 'inline-flex';
        saveBtn.onclick = () => handleSave(entry, rowData, ticket, processedBy);

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.style.display = isSaved ? 'inline-flex' : 'none';
        editBtn.onclick = () => {
          input.disabled = false;
          input.focus();
          saveBtn.style.display = 'inline-flex';
          editBtn.style.display = 'none';
          deleteBtn.style.display = 'none';
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.style.display = isSaved ? 'inline-flex' : 'none';
        deleteBtn.onclick = () => handleDelete(entry);

        buttons.appendChild(saveBtn);
        buttons.appendChild(editBtn);
        buttons.appendChild(deleteBtn);
        entry.appendChild(input);
        entry.appendChild(buttons);
        return entry;
      }

      function createActionCell(rowId, rowData, row) {
        const td = document.createElement('td');
        td.className = 'action-cell';
        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.innerHTML = '<i class="bi bi-plus-square"></i>';
        addBtn.onclick = () => {
          const accountsCell = row.querySelector('td:nth-child(5) .account-entries');
          accountsCell.appendChild(createAccountEntry(rowId, rowData, '', els.ticketNumber.value.trim(), els.processedBy.value.trim(), false));
        };
        td.appendChild(addBtn);
        return td;
      }

      function handleSave(entry, rowData, ticket, processedBy) {
        const input = entry.querySelector('input');
        const account = input.value.trim();
        clearError(entry);
        if (!account) {
          showError(entry, 'Account is required');
          return;
        }
        const data = {
          id: entry.dataset.entryId,
          eid: rowData.eid,
          lastName: rowData.lastName,
          firstName: rowData.firstName,
          program: rowData.program,
          accounts: account,
          ticketNumber: ticket,
          processedBy: processedBy,
          dateStamp: new Date().toISOString().split('T')[0]
        };
        saveToDB(data).then(() => {
          input.disabled = true;
          entry.dataset.isSaved = 'true';
          entry.querySelector('.save-btn').style.display = 'none';
          entry.querySelector('.edit-btn').style.display = 'inline-flex';
          entry.querySelector('.delete-btn').style.display = 'inline-flex';
          alert('Account saved successfully!');
        }).catch(err => {
          alert('Save failed: ' + err.message);
        });
      }

      function handleDelete(entry) {
        if (!confirm('Delete this account entry?')) return;
        if (entry.dataset.isSaved === 'true') {
          deleteFromDB(entry.dataset.entryId).then(() => entry.remove()).catch(err => alert('Delete failed'));
        } else {
          entry.remove();
        }
      }

      function showError(entry, msg) {
        clearError(entry);
        const input = entry.querySelector('input');
        input.classList.add('error-input');
        const span = document.createElement('span');
        span.className = 'error-message';
        span.textContent = msg;
        entry.appendChild(span);
      }

      function clearError(entry) {
        const input = entry.querySelector('input');
        if (input) input.classList.remove('error-input');
        entry.querySelectorAll('.error-message').forEach(el => el.remove());
      }

      function openModal() {
        const modal = document.getElementById('clearanceModal');
        const tbody = document.querySelector('#clearanceTable tbody');
        const info = document.getElementById('dataInfo');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">Loading...</td></tr>';

        fetchAllData().then(data => {
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">No data available</td></tr>';
            info.innerHTML = 'Total Records: 0';
          } else {
            data.sort((a, b) => (a.ticketNumber || '').localeCompare(b.ticketNumber || '') || a.eid.localeCompare(b.eid));
            info.innerHTML = `
              <span>Total Records: ${data.length}</span>
              <button id="exportJSONModalBtn" class="export-json-btn">Export to JSON</button>
            `;
            document.getElementById('exportJSONModalBtn').addEventListener('click', exportToJSON);
            tbody.innerHTML = '';
            data.forEach(r => {
              const tr = document.createElement('tr');
              [r.ticketNumber, r.eid, r.lastName, r.firstName, r.program, r.accounts, r.processedBy, r.dateStamp].forEach(val => {
                const td = document.createElement('td');
                td.textContent = val || '';
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
          }
        }).catch(err => {
          console.error('Modal load error:', err);
          tbody.innerHTML = '<tr><td colspan="8" class="no-data">Error loading data</td></tr>';
          info.textContent = 'Error';
        });
      }

      function closeModal() {
        const modal = document.getElementById('clearanceModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }

      window.onclick = e => { if (e.target === document.getElementById('clearanceModal')) closeModal(); };
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    });

    initDB().catch(err => console.error('DB init failed:', err));
  </script>
</body>
</html>
